<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MMQR — Static → Dynamic QR</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;max-width:1000px;margin:20px auto;padding:20px;line-height:1.4;color:#111}
    h1{font-size:22px;margin-bottom:10px}
    .card{border:1px solid #ddd;padding:12px;border-radius:8px;margin-bottom:16px}
    label{display:block;margin:6px 0;font-weight:600}
    input,textarea{width:100%;padding:6px;border:1px solid #ccc;border-radius:4px;font-size:14px}
    textarea{height:80px;font-family:monospace}
    button{margin:6px 4px 0 0;padding:6px 12px;border:0;border-radius:6px;background:#0b6efd;color:#fff;cursor:pointer}
    .qr-box{display:flex;align-items:center;justify-content:center;height:260px;margin-top:10px}
    .hidden{display:none}
    .muted{color:#666;font-size:13px}
  </style>
</head>
<body>
<h1>MMQR — Static → Dynamic QR (regenerated)</h1>
<div class="card">
  <label>Upload QR image</label>
  <input id="fileInput" type="file" accept="image/*" />
  <label>Or paste EMV string</label>
  <textarea id="rawInput" placeholder="000201...">00020101021226500015com.mmqrpay.www011562060109999000102081000106252041731530310454073535.875802MM5914Aung Chan Thar6006Yangon61051101162140210094302344464350002MY0114Aung Chan Thar0207ရန်ကုန်6304BA12</textarea>
  <button id="btnParse">Parse</button>
  <div class="muted">Parsing preserves original tags. Generate will reorder to the standard EMV sequence (54 placed after 53).</div>
</div>
<div class="card">
  <label>54 — Amount (mandatory, default 5232.67)</label>
  <input id="input54" type="text" placeholder="5232.67" />
  <label>62.01 — Bill Number (auto timestamp)</label>
  <input id="input6201" type="text" placeholder="auto timestamp" />
  <label>62.02 — Phone (default 0943023332)</label>
  <input id="input6202" type="text" placeholder="0943023332" />
  <label>62.05 — Merchant Ref (auto REFID+10digit)</label>
  <input id="input6205" type="text" placeholder="auto REFID+10digit" />
  <label>62.08 — Purpose (random name if blank)</label>
  <input id="input6208" type="text" placeholder="random name" />  <div style="margin-top:8px">
    <button id="btnGenerate">Generate Dynamic QR</button>
    <button id="btnToggleQR">Hide QR</button>
    <button id="btnDownload">Download PNG</button>
  </div>
</div>
<div class="card">
  <label>Dynamic QR String</label>
  <textarea id="resultString" readonly></textarea>
  <div class="qr-box hidden" id="qrBox"></div>
</div><script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script><script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script><script>
const $=id=>document.getElementById(id);
let lastParsed=null;
 
// Utilities
function pad2(n){return n<10?('0'+n):String(n);}
function byteLen(s){ return new TextEncoder().encode(s||'').length; }
function timestampString(){const d=new Date();const z=n=>String(n).padStart(2,'0');return `${d.getFullYear()}${z(d.getMonth()+1)}${z(d.getDate())}${z(d.getHours())}${z(d.getMinutes())}${z(d.getSeconds())}`;}
function randomDigits(n){let s='';for(let i=0;i<n;i++)s+=Math.floor(Math.random()*10);return s;}
function randomName(){const names=['ShopOne','SuperMart','GoldenStore','LuckyMart','BestBuy','GrandShop','GreenMart','CityShop'];return names[Math.floor(Math.random()*names.length)];}
 
// Parse EMV TLV string into ordered array (keeps original order)
function parseEMV(str){
  const out=[];let i=0;
  while(i<str.length){
    const tag=str.substr(i,2); i+=2;
    const len=parseInt(str.substr(i,2),10); i+=2;
    const val=str.substr(i,len); i+=len;
    const item={tag,len,value:val};
    if(tag==='26' || tag==='62' || tag==='64'){ item.children = parseEMV(val); }
    out.push(item);
  }
  return out;
}
function childrenToMap(children){const m={};(children||[]).forEach(c=>m[c.tag]=c.value);return m;}
 
// CRC-16-CCITT (poly 0x1021) initial 0xFFFF, compute over UTF-8 bytes
function CRC16CCITT_Unicode(data){
  const polynomial=0x1021; let crc=0xFFFF;
  const buffer=new TextEncoder().encode(data);
  for(let b of buffer){
    crc ^= (b << 8);
    for(let i=0;i<8;i++){
      crc = (crc & 0x8000) ? ((crc << 1) ^ polynomial) : (crc << 1);
      crc &= 0xFFFF;
    }
  }
  return crc.toString(16).toUpperCase().padStart(4,'0');
}
 
// Canonical order for EMV QR building. Any tags not in this list will be appended in original order.
const CANONICAL_ORDER = ['00','01','26','52','53','54','55','56','57','58','59','60','61','62','64','63'];
 
function reorderParsed(parsed){
  const map = new Map();
  const originalOrder = [];
  parsed.forEach(p=>{ map.set(p.tag, p); originalOrder.push(p.tag); });
  const out = [];
  CANONICAL_ORDER.forEach(tag=>{ if(map.has(tag)){ out.push(map.get(tag)); map.delete(tag); }});
  // append remaining in their original order
  originalOrder.forEach(tag=>{ if(map.has(tag)){ out.push(map.get(tag)); map.delete(tag); }});
  return out;
}

function applyEdits(){
  const amt = $('input54').value.trim() || '5232.67';

  // ✅ Ensure Dynamic QR tag 01 = "12"
  let tag01 = lastParsed.find(p=>p.tag==='01');
  if(!tag01){
    lastParsed.push({tag:'01', len:2, value:'12'});
  } else {
    tag01.len = 2;
    tag01.value = '12';
  }

  // Remove existing 54 and re-add
  lastParsed = lastParsed.filter(p=>p.tag!=='54');
  const idx53 = lastParsed.findIndex(p=>p.tag==='53');
  if(idx53 >= 0){
    lastParsed.splice(idx53+1, 0, {tag:'54', len:byteLen(amt), value:amt});
  } else {
    lastParsed.push({tag:'54', len:byteLen(amt), value:amt});
  }

  // Ensure tag 62 exists with children
  let p62 = lastParsed.find(p=>p.tag==='62');
  if(!p62){ p62 = {tag:'62', len:0, value:'', children:[]}; lastParsed.push(p62); }
  const childMap = p62.children ? childrenToMap(p62.children) : {};
  childMap['01'] = timestampString();                // Bill No
  childMap['02'] = '0943023332';                     // Phone
  childMap['05'] = 'REFID' + randomDigits(10);       // Merchant Ref
  childMap['08'] = randomName();                     // Purpose

  const newChildren = Object.keys(childMap).sort().map(k=>({ tag:k, len:byteLen(childMap[k]), value:childMap[k] }));
  p62.children = newChildren;
  p62.value = newChildren.map(c=>`${c.tag}${pad2(byteLen(c.value))}${c.value}`).join('');
  p62.len = byteLen(p62.value);

  // Remove CRC if any and reorder
  lastParsed = lastParsed.filter(p=>p.tag!=='63');
  lastParsed = reorderParsed(lastParsed);
}


  
// Build EMV TLV using UTF-8 byte lengths for length fields
function buildEMV(parsed){
  function buildItem(item){
    if(item.children){
      const childStr = item.children.map(c=> `${c.tag}${pad2(byteLen(c.value))}${c.value}`).join('');
      return `${item.tag}${pad2(byteLen(childStr))}${childStr}`;
    } else {
      return `${item.tag}${pad2(byteLen(item.value))}${item.value}`;
    }
  }
  return parsed.map(buildItem).join('');
}
 
// Rebuild payload and append CRC (63)
function rebuildWithCRC(parsed){
  // ensure CRC tag removed
  parsed = parsed.filter(p=>p.tag!=='63');
  // reorder to canonical
  parsed = reorderParsed(parsed);
  const without63 = buildEMV(parsed);
  const toCrc = without63 + '6304';
  const crc = CRC16CCITT_Unicode(toCrc);
  return toCrc + crc;
}
 
// UI handlers
$('fileInput').addEventListener('change', async ev => {
  const f = ev.target.files[0]; if(!f) return;
  const img = await fileToImage(f); const raw = await decodeImageToString(img);
  if(raw){ $('rawInput').value = raw; } else { alert('No QR payload found in image'); }
});
 
$('btnParse').addEventListener('click', ()=>{
  const raw = $('rawInput').value.trim(); if(!raw){ alert('Paste EMV string or upload QR'); return; }
  try{ lastParsed = parseEMV(raw); $('resultString').value = raw; } catch(e){ alert('Parse error: '+e.message); }
});
 
$('btnGenerate').addEventListener('click', ()=>{
  if(!lastParsed){ alert('Parse QR first'); return; }
  try{ applyEdits(); const s = rebuildWithCRC(lastParsed); $('resultString').value = s; renderQR(s); $('qrBox').classList.remove('hidden'); }catch(e){ alert('Error: '+e.message); }
});
 
$('btnToggleQR').addEventListener('click', ()=>{ $('qrBox').classList.toggle('hidden'); });
$('btnDownload').addEventListener('click', ()=>{ const img = $('qrBox').querySelector('img'); if(!img){ alert('No QR generated'); return; } const a=document.createElement('a'); a.href=img.src; a.download='mmqr.png'; a.click(); });
 
function applyEdits(){
  // Amount
  const amt = $('input54').value.trim() || '5232.67';
  // Remove any existing 54 entries
  lastParsed = lastParsed.filter(p=>p.tag!=='54');
  // Find 53 index
  const idx53 = lastParsed.findIndex(p=>p.tag==='53');
  if(idx53 >= 0){
    // insert 54 immediately after 53
    lastParsed.splice(idx53+1, 0, {tag:'54', len:byteLen(amt), value:amt});
  } else {
    // no 53 — append 54 at the end
    lastParsed.push({tag:'54', len:byteLen(amt), value:amt});
  }
 
  // Ensure 62 exists
  let p62 = lastParsed.find(p=>p.tag==='62');
  if(!p62){ p62 = {tag:'62', len:0, value:'', children:[]}; lastParsed.push(p62); }
  const childMap = p62.children ? childrenToMap(p62.children) : {};
  childMap['01'] = $('input6201').value.trim() || timestampString();
  childMap['02'] = $('input6202').value.trim() || '0943023332';
  childMap['05'] = $('input6205').value.trim() || ('REFID'+randomDigits(10));
  childMap['08'] = $('input6208').value.trim() || randomName();
  // rebuild children, keep numeric sort for sub-tags
  const newChildren = Object.keys(childMap).sort().map(k=>({ tag:k, len:byteLen(childMap[k]), value:childMap[k] }));
  p62.children = newChildren; p62.value = newChildren.map(c=>`${c.tag}${pad2(byteLen(c.value))}${c.value}`).join(''); p62.len = byteLen(p62.value);
 
  // remove existing CRC if any
  lastParsed = lastParsed.filter(p=>p.tag!=='63');
  // reorder to canonical (so 54 will be after 53)
  lastParsed = reorderParsed(lastParsed);
}
 
// QR helpers
function renderQR(text){ const qrBox = $('qrBox'); qrBox.innerHTML = ''; const qr = new QRious({value:text, size:400}); const img = document.createElement('img'); img.src = qr.toDataURL(); img.alt='mmqr'; img.style.maxWidth='100%'; qrBox.appendChild(img); }
function fileToImage(file){ return new Promise((res,rej)=>{ const fr = new FileReader(); fr.onload = ()=>{ const img = new Image(); img.onload = ()=>res(img); img.onerror = rej; img.src = fr.result; }; fr.onerror = rej; fr.readAsDataURL(file); }); }
function decodeImageToString(img){ const c = document.createElement('canvas'); c.width = img.naturalWidth; c.height = img.naturalHeight; const ctx = c.getContext('2d'); ctx.drawImage(img,0,0); const imgData = ctx.getImageData(0,0,c.width,c.height); const code = jsQR(imgData.data, c.width, c.height); return code ? code.data : null; }
 
</script></body>
</html>
